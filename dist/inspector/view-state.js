'use strict';
Object.defineProperty(exports, "__esModule", { value: true });
exports.ready = exports.update = exports.$ = exports.template = void 0;
const fs_1 = require("fs");
exports.template = `
<ui-prop type="dump" class="content"></ui-prop>
`;
exports.$ = {
    content: '.content',
};
const createSelectorProp = (labelText, selectorClassName, selectorDefaultValue, selectorOptions = [], selectCb = null) => {
    const selectorProp = document.createElement('ui-prop');
    const label = document.createElement('ui-label');
    label.setAttribute('slot', 'label');
    label.innerText = labelText;
    const selector = createSelector(selectorClassName, selectorDefaultValue, selectorOptions, selectCb);
    selectorProp.appendChild(label);
    selectorProp.appendChild(selector);
    return selectorProp;
};
const createSelector = (className, defaultValue, selectorOptions = [], selectCb = null) => {
    const selector = document.createElement('ui-select');
    selector.setAttribute('class', className);
    selector.setAttribute('slot', 'content');
    if (defaultValue) {
        selector.setAttribute('value', defaultValue);
    }
    selectorOptions.forEach((option) => {
        selector.appendChild(createOption(option));
    });
    selector.addEventListener('change', (event) => {
        var _a;
        //@ts-ignore
        selectCb && selectCb((_a = event.target) === null || _a === void 0 ? void 0 : _a.value);
    });
    selector.addEventListener('confirm', (event) => {
        var _a;
        //@ts-ignore
        selectCb && selectCb((_a = event.target) === null || _a === void 0 ? void 0 : _a.value);
    });
    return selector;
};
const createOption = (selectorOption) => {
    const option = document.createElement('option');
    option.setAttribute('value', selectorOption.value);
    option.innerText = selectorOption.text;
    return option;
};
async function update(dump) {
    var _a;
    this.dump = dump;
    const content = this.$.content;
    const editorMode = Editor.EditMode.getMode();
    if (editorMode === "animation") {
        while (content.firstChild) {
            content.removeChild(content.firstChild);
        }
    }
    for (const key in dump.value) {
        const value = dump.value[key];
        let $prop = content.querySelector(`ui-prop[key=${key}]`);
        if ($prop) {
            $prop.hidden = !value.visible;
        }
        if (!value.visible) {
            continue;
        }
        if (!$prop) {
            $prop = document.createElement('ui-prop');
            $prop.setAttribute('key', key);
            $prop.setAttribute('type', 'dump');
            content.appendChild($prop);
        }
        $prop.render(value);
        if (key == "defaultClip") {
            const uuid = (_a = value === null || value === void 0 ? void 0 : value.value) === null || _a === void 0 ? void 0 : _a.uuid;
            if (uuid) {
                const assetInfo = await Editor.Message.request('asset-db', 'query-asset-info', uuid);
                if (assetInfo) {
                    const data = (0, fs_1.readFileSync)(assetInfo.file, 'utf8');
                    try {
                        const json = JSON.parse(data);
                        if (json && Array.isArray(json)) {
                            const clip = json.find(item => item.__type__ == "cc.AnimationClip");
                            if (clip) {
                                const clipEvents = clip._events;
                                if (clipEvents && Array.isArray(clipEvents)) {
                                    const map = new Map();
                                    for (const event of clipEvents) {
                                        const has = map.get(event.frame);
                                        if (has) {
                                            // 有名字的事件会替换掉没有名字的事件
                                            if (!has.func && event.func) {
                                                map.set(event.frame, event);
                                            }
                                        }
                                        else {
                                            map.set(event.frame, event);
                                        }
                                    }
                                    const events = Array.from(map.values());
                                    let $prop = createSelectorProp("State", "event", "0", events.map((event, index) => ({ value: index.toString(), text: event.func || "状态" + (index + 1) })), async (v) => {
                                        await Editor.Message.request('scene', 'execute-component-method', {
                                            uuid: dump.value.uuid.value,
                                            name: 'editorChangeState',
                                            args: v,
                                        });
                                    });
                                    content.appendChild($prop);
                                }
                            }
                        }
                    }
                    catch (error) {
                        console.error("Failed to parse view state data:", error);
                    }
                }
            }
        }
    }
}
exports.update = update;
function ready() { }
exports.ready = ready;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidmlldy1zdGF0ZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NvdXJjZS9pbnNwZWN0b3Ivdmlldy1zdGF0ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxZQUFZLENBQUM7OztBQUdiLDJCQUFrQztBQU1yQixRQUFBLFFBQVEsR0FBRzs7Q0FFdkIsQ0FBQztBQUVXLFFBQUEsQ0FBQyxHQUFHO0lBQ2IsT0FBTyxFQUFFLFVBQVU7Q0FDdEIsQ0FBQztBQUdGLE1BQU0sa0JBQWtCLEdBQUcsQ0FBQyxTQUFpQixFQUFFLGlCQUF5QixFQUFFLG9CQUE2QixFQUFFLGtCQUFvQyxFQUFFLEVBQUUsV0FBb0MsSUFBSyxFQUFlLEVBQUU7SUFDdk0sTUFBTSxZQUFZLEdBQUcsUUFBUSxDQUFDLGFBQWEsQ0FBQyxTQUFTLENBQUMsQ0FBQztJQUN2RCxNQUFNLEtBQUssR0FBRyxRQUFRLENBQUMsYUFBYSxDQUFDLFVBQVUsQ0FBQyxDQUFDO0lBQ2pELEtBQUssQ0FBQyxZQUFZLENBQUMsTUFBTSxFQUFFLE9BQU8sQ0FBQyxDQUFDO0lBQ3BDLEtBQUssQ0FBQyxTQUFTLEdBQUcsU0FBUyxDQUFDO0lBQzVCLE1BQU0sUUFBUSxHQUFHLGNBQWMsQ0FBQyxpQkFBaUIsRUFBRSxvQkFBb0IsRUFBRSxlQUFlLEVBQUUsUUFBUSxDQUFDLENBQUM7SUFDcEcsWUFBWSxDQUFDLFdBQVcsQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUNoQyxZQUFZLENBQUMsV0FBVyxDQUFDLFFBQVEsQ0FBQyxDQUFDO0lBQ25DLE9BQU8sWUFBWSxDQUFDO0FBQ3hCLENBQUMsQ0FBQztBQUVGLE1BQU0sY0FBYyxHQUFHLENBQUMsU0FBaUIsRUFBRSxZQUFxQixFQUFFLGtCQUFvQyxFQUFFLEVBQUUsV0FBb0MsSUFBSyxFQUFlLEVBQUU7SUFDaEssTUFBTSxRQUFRLEdBQUcsUUFBUSxDQUFDLGFBQWEsQ0FBQyxXQUFXLENBQUMsQ0FBQztJQUNyRCxRQUFRLENBQUMsWUFBWSxD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cG9ydCB7IEFzc2V0SW5mbyB9IGZyb20gXCJAY29jb3MvY3JlYXRvci10eXBlcy9lZGl0b3IvcGFja2FnZXMvYXNzZXQtZGIvQHR5cGVzL3B1YmxpY1wiO1xuaW1wb3J0IHsgcmVhZEZpbGVTeW5jIH0gZnJvbSBcImZzXCI7XG5cbnR5cGUgU2VsZWN0b3I8JD4gPSB7ICQ6IFJlY29yZDxrZXlvZiAkLCBhbnkgfCBudWxsPiB9O1xuXG50eXBlIFBhbmVsVGhpcyA9IFNlbGVjdG9yPHR5cGVvZiAkPiAmIHsgZHVtcDogYW55IH07XG5cbmV4cG9ydCBjb25zdCB0ZW1wbGF0ZSA9IGBcbjx1aS1wcm9wIHR5cGU9XCJkdW1wXCIgY2xhc3M9XCJjb250ZW50XCI+PC91aS1wcm9wPlxuYDtcblxuZXhwb3J0IGNvbnN0ICQgPSB7XG4gICAgY29udGVudDogJy5jb250ZW50Jyxcbn07XG5cblxuY29uc3QgY3JlYXRlU2VsZWN0b3JQcm9wID0gKGxhYmVsVGV4dDogc3RyaW5nLCBzZWxlY3RvckNsYXNzTmFtZTogc3RyaW5nLCBzZWxlY3RvckRlZmF1bHRWYWx1ZT86IHN0cmluZywgc2VsZWN0b3JPcHRpb25zOiBTZWxlY3Rvck9wdGlvbltdID0gW10sIHNlbGVjdENiOiAodmFsdWU6IHN0cmluZykgPT4gdm9pZCA9IG51bGwhKTogSFRNTEVsZW1lbnQgPT4ge1xuICAgIGNvbnN0IHNlbGVjdG9yUHJvcCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3VpLXByb3AnKTtcbiAgICBjb25zdCBsYWJlbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3VpLWxhYmVsJyk7XG4gICAgbGFiZWwuc2V0QXR0cmlidXRlKCdzbG90JywgJ2xhYmVsJyk7XG4gICAgbGFiZWwuaW5uZXJUZXh0ID0gbGFiZWxUZXh0O1xuICAgIGNvbnN0IHNlbGVjdG9yID0gY3JlYXRlU2VsZWN0b3Ioc2VsZWN0b3JDbGFzc05hbWUsIHNlbGVjdG9yRGVmYXVsdFZhbHVlLCBzZWxlY3Rvck9wdGlvbnMsIHNlbGVjdENiKTtcbiAgICBzZWxlY3RvclByb3AuYXBwZW5kQ2hpbGQobGFiZWwpO1xuICAgIHNlbGVjdG9yUHJvcC5hcHBlbmRDaGlsZChzZWxlY3Rvcik7XG4gICAgcmV0dXJuIHNlbGVjdG9yUHJvcDtcbn07XG5cbmNvbnN0IGNyZWF0ZVNlbGVjdG9yID0gKGNsYXNzTmFtZTogc3RyaW5nLCBkZWZhdWx0VmFsdWU/OiBzdHJpbmcsIHNlbGVjdG9yT3B0aW9uczogU2VsZWN0b3JPcHRpb25bXSA9IFtdLCBzZWxlY3RDYjogKHZhbHVlOiBzdHJpbmcpID0+IHZvaWQgPSBudWxsISk6IEhUTUxFbGVtZW50ID0+IHtcbiAgICBjb25zdCBzZWxlY3RvciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3VpLXNlbGVjdCcpO1xuICAgIHNlbGVjdG9yLnNldEF0dHJpYnV0ZSgnY2xhc3MnLCBjbGFzc05hbWUpO1xuICAgIHNlbGVjdG9yLnNldEF0dHJpYnV0ZSgnc2xvdCcsICdjb250ZW50Jyk7XG4gICAgaWYgKGRlZmF1bHRWYWx1ZSkge1xuICAgICAgICBzZWxlY3Rvci5zZXRBdHRyaWJ1dGUoJ3ZhbHVlJywgZGVmYXVsdFZhbHVlKTtcbiAgICB9XG4gICAgc2VsZWN0b3JPcHRpb25zLmZvckVhY2goKG9wdGlvbikgPT4ge1xuICAgICAgICBzZWxlY3Rvci5hcHBlbmRDaGlsZChjcmVhdGVPcHRpb24ob3B0aW9uKSk7XG4gICAgfSk7XG4gICAgc2VsZWN0b3IuYWRkRXZlbnRMaXN0ZW5lcignY2hhbmdlJywgKGV2ZW50KSA9PiB7XG4gICAgICAgIC8vQHRzLWlnbm9yZVxuICAgICAgICBzZWxlY3RDYiAmJiBzZWxlY3RDYihldmVudC50YXJnZXQ/LnZhbHVlKTtcbiAgICB9KTtcbiAgICBzZWxlY3Rvci5hZGRFdmVudExpc3RlbmVyKCdjb25maXJtJywgKGV2ZW50KSA9PiB7XG4gICAgICAgIC8vQHRzLWlnbm9yZVxuICAgICAgICBzZWxlY3RDYiAmJiBzZWxlY3RDYihldmVudC50YXJnZXQ/LnZhbHVlKTtcbiAgICB9KTtcbiAgICByZXR1cm4gc2VsZWN0b3I7XG59O1xuXG5pbnRlcmZhY2UgU2VsZWN0b3JPcHRpb24ge1xuICAgIHZhbHVlOiBzdHJpbmc7XG4gICAgdGV4dDogc3RyaW5nO1xufVxuXG5jb25zdCBjcmVhdGVPcHRpb24gPSAoc2VsZWN0b3JPcHRpb246IFNlbGVjdG9yT3B0aW9uKTogSFRNTEVsZW1lbnQgPT4ge1xuICAgIGNvbnN0IG9wdGlvbiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ29wdGlvbicpO1xuICAgIG9wdGlvbi5zZXRBdHRyaWJ1dGUoJ3ZhbHVlJywgc2VsZWN0b3JPcHRpb24udmFsdWUpO1xuICAgIG9wdGlvbi5pbm5lclRleHQgPSBzZWxlY3Rvck9wdGlvbi50ZXh0O1xuICAgIHJldHVybiBvcHRpb247XG59O1xuXG50eXBlIFVJUHJvcCA9IEhUTUxFbGVtZW50ICYgeyByZW5kZXIoZHVtcDogYW55KTogdm9pZCB9O1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHVwZGF0ZSh0aGlzOiBQYW5lbFRoaXMsIGR1bXA6IGFueSkge1xuICAgIHRoaXMuZHVtcCA9IGR1bXA7XG4gICAgY29uc3QgY29udGVudCA9ICh0aGlzLiQuY29udGVudCBhcyBIVE1MRWxlbWVudCk7XG4gICAgY29uc3QgZWRpdG9yTW9kZSA9IEVkaXRvci5FZGl0TW9kZS5nZXRNb2RlKCk7XG5cbiAgICBpZiAoZWRpdG9yTW9kZSA9PT0gXCJhbmltYXRpb25cIikge1xuICAgICAgICB3aGlsZSAoY29udGVudC5maXJzdENoaWxkKSB7XG4gICAgICAgICAgICBjb250ZW50LnJlbW92ZUNoaWxkKGNvbnRlbnQuZmlyc3RDaGlsZCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBmb3IgKGNvbnN0IGtleSBpbiBkdW1wLnZhbHVlKSB7XG4gICAgICAgIGNvbnN0IHZhbHVlID0gZHVtcC52YWx1ZVtrZXldO1xuICAgICAgICBsZXQgJHByb3A6IFVJUHJvcCB8IG51bGwgPSBjb250ZW50LnF1ZXJ5U2VsZWN0b3IoYHVpLXByb3Bba2V5PSR7a2V5fV1gKTtcbiAgICAgICAgaWYgKCRwcm9wKSB7XG4gICAgICAgICAgICAkcHJvcC5oaWRkZW4gPSAhdmFsdWUudmlzaWJsZTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoIXZhbHVlLnZpc2libGUpIHtcbiAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKCEkcHJvcCkge1xuICAgICAgICAgICAgJHByb3AgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCd1aS1wcm9wJykgYXMgVUlQcm9wO1xuICAgICAgICAgICAgJHByb3Auc2V0QXR0cmlidXRlKCdrZXknLCBrZXkpO1xuICAgICAgICAgICAgJHByb3Auc2V0QXR0cmlidXRlKCd0eXBlJywgJ2R1bXAnKTtcbiAgICAgICAgICAgIGNvbnRlbnQuYXBwZW5kQ2hpbGQoJHByb3ApO1xuICAgICAgICB9XG4gICAgICAgICRwcm9wLnJlbmRlcih2YWx1ZSk7XG5cbiAgICAgICAgaWYgKGtleSA9PSBcImRlZmF1bHRDbGlwXCIpIHtcbiAgICAgICAgICAgIGNvbnN0IHV1aWQgPSB2YWx1ZT8udmFsdWU/LnV1aWQ7XG4gICAgICAgICAgICBpZiAodXVpZCkge1xuICAgICAgICAgICAgICAgIGNvbnN0IGFzc2V0SW5mbyA9IGF3YWl0IEVkaXRvci5NZXNzYWdlLnJlcXVlc3QoJ2Fzc2V0LWRiJywgJ3F1ZXJ5LWFzc2V0LWluZm8nLCB1dWlkKSBhcyBBc3NldEluZm8gfCBudWxsO1xuICAgICAgICAgICAgICAgIGlmIChhc3NldEluZm8pIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgZGF0YSA9IHJlYWRGaWxlU3luYyhhc3NldEluZm8uZmlsZSwgJ3V0ZjgnKTtcblxuICAgICAgICAgICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QganNvbiA9IEpTT04ucGFyc2UoZGF0YSk7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoanNvbiAmJiBBcnJheS5pc0FycmF5KGpzb24pKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgY2xpcCA9IGpzb24uZmluZChpdGVtID0+IGl0ZW0uX190eXBlX18gPT0gXCJjYy5BbmltYXRpb25DbGlwXCIpO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNsaXApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgY2xpcEV2ZW50cyA9IGNsaXAuX2V2ZW50cztcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNsaXBFdmVudHMgJiYgQXJyYXkuaXNBcnJheShjbGlwRXZlbnRzKSkge1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbnRlcmZhY2UgSUV2ZW50IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmcmFtZTogbnVtYmVyO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZ1bmM6IHN0cmluZztcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXJhbXM6IHN0cmluZ1tdO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbWFwID0gbmV3IE1hcDxudW1iZXIsIElFdmVudD4oKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoY29uc3QgZXZlbnQgb2YgY2xpcEV2ZW50cykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGhhcyA9IG1hcC5nZXQoZXZlbnQuZnJhbWUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChoYXMpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8g5pyJ5ZCN5a2X55qE5LqL5Lu25Lya5pu/5o2i5o6J5rKh5pyJ5ZCN5a2X55qE5LqL5Lu2XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghaGFzLmZ1bmMgJiYgZXZlbnQuZnVuYykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWFwLnNldChldmVudC5mcmFtZSwgZXZlbnQpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWFwLnNldChldmVudC5mcmFtZSwgZXZlbnQpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZXZlbnRzOiBJRXZlbnRbXSA9IEFycmF5LmZyb20obWFwLnZhbHVlcygpKTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0ICRwcm9wID0gY3JlYXRlU2VsZWN0b3JQcm9wKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFwiU3RhdGVcIixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcImV2ZW50XCIsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXCIwXCIsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnRzLm1hcChcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKGV2ZW50LCBpbmRleCkgPT4gKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgeyB2YWx1ZTogaW5kZXgudG9TdHJpbmcoKSwgdGV4dDogZXZlbnQuZnVuYyB8fCBcIueKtuaAgVwiICsgKGluZGV4ICsgMSkgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhc3luYyAodjogc3RyaW5nKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF3YWl0IEVkaXRvci5NZXNzYWdlLnJlcXVlc3QoJ3NjZW5lJywgJ2V4ZWN1dGUtY29tcG9uZW50LW1ldGhvZCcsIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHV1aWQ6IGR1bXAudmFsdWUudXVpZC52YWx1ZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWU6ICdlZGl0b3JDaGFuZ2VTdGF0ZScsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcmdzOiB2LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGVudC5hcHBlbmRDaGlsZCgkcHJvcCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKFwiRmFpbGVkIHRvIHBhcnNlIHZpZXcgc3RhdGUgZGF0YTpcIiwgZXJyb3IpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxufVxuZXhwb3J0IGZ1bmN0aW9uIHJlYWR5KHRoaXM6IFNlbGVjdG9yPHR5cGVvZiAkPikgeyB9Il19